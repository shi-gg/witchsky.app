when:
  - event: ["manual"]
    branch: ["main"]

engine: "nixery"

dependencies:
  nixpkgs:
    - nodejs-slim_20
    - yarn
    - temurin-jre-bin-17
    - gradle
    - androidenv.androidPkgs.ndk-bundle
    - justbuild

steps:
  - name: Install dependencies
    command: "yarn install --frozen-lockfile"

  - name: Copy example build settings
    command: |
      cp .env.example .env
      cp google-services.json.example google-services.json

  - name: Build
    command: "just dist-build-android-gradle"

  - name: Rename APK
    command: |
      mv android/app/build/outputs/apk/release/app-release.apk android/app/build/outputs/apk/release/witchsky-v${{ github.run_number }}.apk

  - name: Upload artifact
    uses: actions/upload-artifact@v4
    with:
      name: android
      path: android/app/build/outputs/apk/release/witchsky-v${{ github.run_number }}.apk

  - name: Publish release
    uses: softprops/action-gh-release@v2
    if: github.ref == 'refs/heads/main'
    with:
      name: Witchsky v${{ github.run_number }}
      tag_name: witchsky-v${{ github.run_number }}
      files: android/app/build/outputs/apk/release/witchsky-v${{ github.run_number }}.apk